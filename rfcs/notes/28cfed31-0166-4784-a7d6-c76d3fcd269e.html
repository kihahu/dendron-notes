<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  
  <title>Ch05 - Replication - Angela's note universe</title>
  

  <link
    rel="shortcut icon"
    href="https://angelarwang.com/dendron-notes/favicon.ico"
    type="image/x-icon"
  />
  <link
    rel="stylesheet"
    href="https://angelarwang.com/dendron-notes/assets/css/just-the-docs-default.css"
  />
  <script
    type="text/javascript"
    src="https://angelarwang.com/dendron-notes/assets/js/just-the-docs.js"
  ></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/themes/prism.min.css"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
    integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X"
    crossorigin="anonymous"
  />
  <script
    type="text/javascript"
    src="https://angelarwang.com/dendron-notes/assets/js/vendor/lunr.min.js"
  ></script>
  
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   
   
  
<meta name="description" content="This is where I keep and share my notes on books, tech, travel, and other hobbies :)">
<meta name="author" content="[object Object]">

<link rel="canonical" href="https://angelarwang.com/notes/28cfed31-0166-4784-a7d6-c76d3fcd269e.html">

<meta property="og:type" content="article">
<meta property="og:url" content="https://angelarwang.com/notes/28cfed31-0166-4784-a7d6-c76d3fcd269e.html">
<meta property="og:description" content="This is where I keep and share my notes on books, tech, travel, and other hobbies :)">
<meta property="og:image" content="https://angelarwang.com/logo.png">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@{"card":"summary","username":"angelaw_ruohan"}">
<meta name="twitter:url" content="https://angelarwang.com/notes/28cfed31-0166-4784-a7d6-c76d3fcd269e.html">
<meta name="twitter:description" content="This is where I keep and share my notes on books, tech, travel, and other hobbies :)">
<meta name="twitter:image" content="https://angelarwang.com/logo.png">


  <meta property="og:title" content="Ch05 - Replication - Angela's note universe" />
  <meta name="twitter:title" content="Ch05 - Replication - Angela's note universe" />
  
</head>



<body>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
      <symbol id="svg-link" viewBox="0 0 24 24">
        <title>Link</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link">
          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
        </svg>
      </symbol>
      <symbol id="svg-search" viewBox="0 0 24 24">
        <title>Search</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search">
          <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </symbol>
      <symbol id="svg-menu" viewBox="0 0 24 24">
        <title>Menu</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
          <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </symbol>
      <symbol id="svg-arrow-right" viewBox="0 0 24 24">
        <title>Expand</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </symbol>
      <symbol id="svg-doc" viewBox="0 0 24 24">
        <title>Document</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file">
          <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline>
        </svg>
      </symbol>
    </svg>

    <div class="side-bar">
      <div class="site-header">
        <a href="https://angelarwang.com/dendron-notes" class="site-title lh-tight">
  <div class="site-logo"></div>

 </a>
        <a href="#" id="menu-button" class="site-button">
          <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg>
        </a>
      </div>

      <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">
      </nav>
      <footer class="site-footer">
        🌱 with 💕 using <a href="https://www.dendron.so/"> Dendron 🌲 </a>
      </footer>
    </div>
    <div class="main" id="top">
        <div id="main-header" class="main-header">
          
            <div class="search">
              <div class="search-input-wrap">
                <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Angela's note universe" aria-label="Search Angela's note universe" autocomplete="off">
                <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label>
              </div>
              <div id="search-results" class="search-results"></div>
            </div>
          
          
    </div>
    <div id="main-content-wrap" class="main-content-wrap">
      
        
          <nav aria-label="Breadcrumb" class="breadcrumb-nav">
            <ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="https://angelarwang.com/dendron-notes">Root</a></li><li class="breadcrumb-nav-list-item"><a href="https://angelarwang.com/dendron-notes/notes\d088ab77-c2f6-4f7a-be4a-7597b00daff0.html">Books</a></li><li class="breadcrumb-nav-list-item"><a href="https://angelarwang.com/dendron-notes/notes\ede45f4d-8d30-42a9-bd27-f1b3ba37d6e0.html">Tech</a></li><li class="breadcrumb-nav-list-item"><a href="https://angelarwang.com/dendron-notes/notes\a42eba1d-b978-4cdc-9160-1f3e9c7cf025.html">Designing Data-intensive Applications</a></li><li class="breadcrumb-nav-list-item">Ch05 - Replication</li></ol>
          </nav>
        
      
      <div id="main-content" class="main-content" role="main">

        
        
        <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
        

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
        
        

        

        

        

        <script>
          $(function () {
            $('[data-toggle="popover"]').popover({html: true})
          })
        </script>

        

<div id="main" role="main">

  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Ch05 - Replication">
    
    <meta itemprop="datePublished" content="2020-11-01T15:40:28+00:00">
    <meta itemprop="dateModified" content="2021-02-28T13:30:39+00:00">

    <div class="page__inner-wrap">

      

      <section class="page__content" itemprop="text">

        

        <h1 id="ch05---replication"><a aria-hidden="true" class="anchor-heading" href="#ch05---replication"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Ch05 - Replication</h1>
<p>Reasons for multi-machine:</p>
<ul>
<li>scalability</li>
<li>HA</li>
<li>latency (route user closer to them)</li>
<li>Disconnected operation</li>
</ul>
<p>Scaling</p>
<ul>
<li>shared-memory  </li>
<li>shared-disk - e.g. Oracle RAC? </li>
<li>shared-nothing . i.e.  horizontal scaling </li>
</ul>
<h2 id="leader-follower-replication"><a aria-hidden="true" class="anchor-heading" href="#leader-follower-replication"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Leader-follower replication</h2>
<ul>
<li>Leader take writes, all can take reads </li>
<li>Used by: 
<ul>
<li>relational: PostgreSQL, MySQL, Oracle Data Guard, SQL Server AlwaysOn Availability Groups</li>
<li>noSQL: MongoDB, RethinkDB, Espresso</li>
<li>Kafka, RabbitMQ</li>
</ul>
</li>
<li>Sync vs Async replication
<ul>
<li>impractical for all followers to be synchronous</li>
<li>if database is configured for sync, usually one of followers is sync, others are async - "<em>semi-synchronous</em>" </li>
</ul>
</li>
<li>Implementation of Replication Logs
<ul>
<li>Statement-based replication
<ul>
<li>not generally used (MySQL before 5.1), because problems:
<ul>
<li>nondeterministic functions e.g. NOW() or RAND()</li>
<li>autoincrementing columns</li>
<li>side effects (triggers, UDFs, etc)</li>
</ul>
</li>
</ul>
</li>
<li>Write-ahead-log shipping
<ul>
<li>WAG: in log structured storage engine, main palce for store. in Btree, WAL before B tree modified</li>
<li>used in PostgreSQL and Oracle</li>
<li>disadvantage: log very low level - specific disk block and bytes
-> problem: <strong>zero-downtime upgrade not possible</strong> if leader and follower can't run with different version of storage engine </li>
</ul>
</li>
<li><strong>Logical (row-based) log replication</strong> 
<ul>
<li>decoupled from storage engine internals</li>
<li>used by MySQL binlog</li>
<li>also can be used by external system, CDC </li>
</ul>
</li>
<li>trigger-based - application layer
<ul>
<li>Oracle GoldenGate or triggers and Stored Procs</li>
</ul>
</li>
</ul>
</li>
<li>Dealing with replication lag and eventual consistency
<ul>
<li>Reading Your Own Writes 
<ul>
<li>option 1: When reading something that the user may have modified, read it from the leader; otherwise, read it from a follower. </li>
<li>option 2: track time of last update, and query leader when within some time window</li>
<li>option 3: client can remember timestamp and require serving replica up to date</li>
</ul>
</li>
<li>Monotonic Reads: second read lags behind first read 
<ul>
<li>option 1: read from same replica</li>
<li>option 2: use sequencer? </li>
</ul>
</li>
<li>consistent prefix read: causual events observed out of order 
<ul>
<li>option 1: causal udpates in the same partition </li>
</ul>
</li>
<li>using transactions -  for a database to provide stronger guarantees so that the application can be simpler.              </li>
</ul>
</li>
</ul>
<h2 id="multi-leader-replication"><a aria-hidden="true" class="anchor-heading" href="#multi-leader-replication"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Multi-leader replication</h2>
<ul>
<li>use case:
<ul>
<li>multi-datacenter</li>
<li>Clients with offline operation
<ul>
<li>offline device each has a local database that acts as leader</li>
</ul>
</li>
<li>Collaborative editing</li>
</ul>
</li>
<li>conflict detection likely async - if sync, might as well use single leader</li>
<li>conflict avoidance
<ul>
<li>different "home" cluster for diff users </li>
</ul>
</li>
<li>achieving convergent conflict resolution 
<ul>
<li>each write unique ID, pick the highest ID </li>
<li>assign priority between writers </li>
<li>merge the values e.g. concat.</li>
<li>record the conflict</li>
</ul>
</li>
<li>custom conflict resolution logic 
<ul>
<li>on write</li>
<li>on read</li>
</ul>
</li>
<li>auto conflict resolution research:
<ul>
<li>Conflict-free replicated datatypes (CRDTs) - family of data structures for sets, maps, ordered lists, counters, etc
<ul>
<li><a href="https://speakerdeck.com/lenary/crdts-an-update-or-just-a-put">CRDTs slide deck</a></li>
</ul>
</li>
<li>Mergeable persistent data structures - like Git, 3 way merge function
<ul>
<li><a href="http://gazagnaire.org/pub/FGM15.pdf">Mergeable Persistent Data Structures paper</a></li>
</ul>
</li>
<li>Operational transformation for collab. editing e.g. Google Docs. 
<ul>
<li><a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.53.933&#x26;rep=rep1&#x26;type=pdf">papaer</a></li>
</ul>
</li>
</ul>
</li>
<li>Multi-Leader Replication Topologies
<ul>
<li>all-to-all, circular, or star (generalize to trees)</li>
<li>circular or star topology may be broken with one failed node</li>
<li>all-to-all has problem of inconsistent ordering </li>
</ul>
</li>
</ul>
<h2 id="leaderless-replication---quorum-based"><a aria-hidden="true" class="anchor-heading" href="#leaderless-replication---quorum-based"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Leaderless Replication - quorum based</h2>
<ul>
<li>"Dynamo-style" - Riak, Cassandra, and Voldemort, inspired by Amazon Dynamo</li>
<li>catch-up options:
<ol>
<li>Read repair - reader can detect stale response and update</li>
<li>anti-entropy - background process</li>
</ol>
</li>
<li>quorum condition: w + r > n  - b.c. set of nodes for w and r must overlap </li>
<li>issues with quorum: 
<ul>
<li>write partial failure needs to be rolled back</li>
<li>eventual consistent without the type of replication lag gaurantees - hard to quantify</li>
<li>difficult to mointor staleness</li>
</ul>
</li>
<li>sloppy quorum:  writes and reads still require w and r successful responses, but those may include nodes that are not among the designated n “home” nodes for a value.
<ul>
<li>once network inerruption is fixed, writes go back to "home" nodes - <em>hinted handoff</em>. so reads might not see the update. </li>
</ul>
</li>
<li>Multi-datacenter: 
<ul>
<li>Cassandra and Voldemort extends quorum to multi-datacenter. high latency writes to other datacenters often async. </li>
<li>Riak - all local. cross-dc happen async in the background </li>
</ul>
</li>
<li>concurrent writes:
<ul>
<li>the application developer neesd to understand the internals on this</li>
<li>Last write wins based on a timestamp
<ul>
<li>only option in Cassandra</li>
<li>optionl on Riak </li>
<li>only safe way: each key is immutable </li>
</ul>
</li>
<li>The “happens-before” relationship:
<ol>
<li>B depends on A -  “happens-before”</li>
<li>A and B are independent  - concurrent</li>
</ol>
</li>
<li>Option 1: Capturing the happens-before relationship (client send version number it depends on)
<ul>
<li>server maintain version for each key </li>
<li>when client writes, must include the version of a prev read and merge with it</li>
<li>server can clean up versions &#x3C;= version number received in the write - since it knows it has been merged. then incre curr version # and return it in response </li>
</ul>
</li>
<li>Option 2: Merging concurrently written values
<ul>
<li>for collections, just union the writes</li>
<li>deletes require a tombstones with a version number </li>
</ul>
</li>
<li>version vectors: multiple replicas, each need a version number 
<ul>
<li>collection of version numbers for all replicats </li>
<li><a href="https://arxiv.org/pdf/1011.5808v1.pdf">Dotted Version Vectors: Logical Clocks for Optimistic Replication paper</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="summary"><a aria-hidden="true" class="anchor-heading" href="#summary"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Summary</h2>
<ul>
<li>Single-leader replication is popular because it is fairly easy to understand and there is no conflict resolution</li>
<li>Multi-leader and quorum based can be more robust in the presence of faulty nodes, network interruptions, and latency spikes—at the cost of being harder to reason about and providing only very weak consistency guarantees.</li>
</ul>
<h2 id="reseach-chain-replication"><a aria-hidden="true" class="anchor-heading" href="#reseach-chain-replication"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Reseach: Chain replication</h2>
<ul>
<li><a href="https://static.usenix.org/events/osdi04/tech/full_papers/renesse/renesse.pdf">Chain Replication for Supporting High Throughput and Availability</a> paper</li>
<li><a href="https://www.usenix.org/legacy/event/usenix09/tech/full_papers/terrace/terrace.pdf">Object Storage on CRAQ
High-throughput chain replication for read-mostly workloads</a> paper </li>
<li><a href="http://sigops.org/s/conferences/sosp/2011/current/2011-Cascais/printable/11-calder.pdf">Windows Azure Storage: A Highly Available
Cloud Storage Service with Strong Consistency</a> paper</li>
</ul><span id="navId" data="28cfed31-0166-4784-a7d6-c76d3fcd269e"></span>

                
      </section>

      
    </div>

    
  </article>

  
  
</div>

        <div class="thumbs feedback_trigger right-bottom"></div>

        
          <hr>
          <footer>
            
            

            
              <div class="d-flex mt-2">
              <p class="text-small text-grey-dk-000 mb-0 mr-2">
                Page last modified: <span class="d-inline-block">2/28/2021</span>.
              </p>
            
                
                  <p class="text-small text-grey-dk-000 mb-0">
                    <a href="https://github.com/angelarw/dendron-notes/edit/gh-pages/vault/books.tech.data-intensive-applications.ch5-replication.md" id="edit-this-page">Edit this page on GitHub</a>
                  </p>
                
              </div>
          </footer>
        
    </div>
</div>


  

  <div class="search-overlay"></div>

</div>

</body>
</html>
