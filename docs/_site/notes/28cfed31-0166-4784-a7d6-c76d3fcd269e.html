<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Ch5 - Replication - Dendron</title> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="http://localhost:4000/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="http://localhost:4000/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="http://localhost:4000/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>Ch5 - Replication | Dendron</title> <meta name="generator" content="Jekyll v3.9.0" /> <meta property="og:title" content="Ch5 - Replication" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Dendron is a local-first, markdown based, hierarchical note taking tool. It is meant to help you create, organize, and collaborate on knowledge bases of any size." /> <meta property="og:description" content="Dendron is a local-first, markdown based, hierarchical note taking tool. It is meant to help you create, organize, and collaborate on knowledge bases of any size." /> <link rel="canonical" href="http://localhost:4000/notes/28cfed31-0166-4784-a7d6-c76d3fcd269e.html" /> <meta property="og:url" content="http://localhost:4000/notes/28cfed31-0166-4784-a7d6-c76d3fcd269e.html" /> <meta property="og:site_name" content="Dendron" /> <meta property="og:image" content="http://localhost:4000/assets/images/logo.png" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:image" content="http://localhost:4000/assets/images/logo.png" /> <meta property="twitter:title" content="Ch5 - Replication" /> <meta name="twitter:site" content="@dendronhq" /> <meta name="twitter:creator" content="@dendronhq" /> <script type="application/ld+json"> {"url":"http://localhost:4000/notes/28cfed31-0166-4784-a7d6-c76d3fcd269e.html","image":"http://localhost:4000/assets/images/logo.png","headline":"Ch5 - Replication","description":"Dendron is a local-first, markdown based, hierarchical note taking tool. It is meant to help you create, organize, and collaborate on knowledge bases of any size.","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/logo.png"}},"@type":"WebPage","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="http://localhost:4000/" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item active"><a href="http://localhost:4000/" class="nav-list-link active">Root</a><ul class="nav-list"><li class="nav-list-item active"><a href="" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/notes/d088ab77-c2f6-4f7a-be4a-7597b00daff0.html" class="nav-list-link active">Book</a><ul class="nav-list"><li class="nav-list-item active"><a href="" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/notes/ede45f4d-8d30-42a9-bd27-f1b3ba37d6e0.html" class="nav-list-link active">Tech</a><ul class="nav-list"><li class="nav-list-item active"><a href="" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/notes/a42eba1d-b978-4cdc-9160-1f3e9c7cf025.html" class="nav-list-link active">Data-intensive-applications</a><ul class="nav-list"><li class="nav-list-item"><a href="http://localhost:4000/notes/e22dd5a3-f940-4548-b1d7-22a26b5386ce.html" class="nav-list-link">Ch4 - Encoding and evolution</a></li><li class="nav-list-item active"><a href="http://localhost:4000/notes/28cfed31-0166-4784-a7d6-c76d3fcd269e.html" class="nav-list-link active">Ch5 - Replication</a></li><li class="nav-list-item"><a href="http://localhost:4000/notes/c61cfa31-05a8-47de-897d-0fbd0a884e69.html" class="nav-list-link">Ch6 - Partitioning</a></li><li class="nav-list-item"><a href="http://localhost:4000/notes/603d252d-91ec-4f35-950e-26211cd5112a.html" class="nav-list-link">Ch7 - Transactions</a></li></ul></li></ul></li></ul></li></ul></li></ul></nav> <footer class="site-footer"> üå± with üíï using <a href="https://www.dendron.so/"> Dendron üå≤ </a> </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Dendron" aria-label="Search Dendron" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="http://localhost:4000/">Root</a></li><li class="breadcrumb-nav-list-item"><a href="http://localhost:4000/notes/d088ab77-c2f6-4f7a-be4a-7597b00daff0.html">Book</a></li><li class="breadcrumb-nav-list-item"><a href="http://localhost:4000/notes/ede45f4d-8d30-42a9-bd27-f1b3ba37d6e0.html">Tech</a></li><li class="breadcrumb-nav-list-item"><a href="http://localhost:4000/notes/a42eba1d-b978-4cdc-9160-1f3e9c7cf025.html">Data-intensive-applications</a></li><li class="breadcrumb-nav-list-item">Ch5 - Replication</li></ol> </nav> <div id="main-content" class="main-content" role="main"> <p>Reasons for multi-machine:</p> <ul> <li>scalability</li> <li>HA</li> <li>latency (route user closer to them)</li> <li>Disconnected operation</li> </ul> <p>Scaling</p> <ul> <li>shared-memory</li> <li>shared-disk - e.g. Oracle RAC?</li> <li>shared-nothing . i.e. horizontal scaling</li> </ul> <h2 id="leader-follower-replication"> <a href="#leader-follower-replication" aria-labelledby="leader-follower-replication" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Leader-follower replication </h2> <ul> <li>Leader take writes, all can take reads</li> <li>Used by: <ul> <li>relational: PostgreSQL, MySQL, Oracle Data Guard, SQL Server AlwaysOn Availability Groups</li> <li>noSQL: MongoDB, RethinkDB, Espresso</li> <li>Kafka, RabbitMQ</li> </ul> </li> <li>Sync vs Async replication <ul> <li>impractical for all followers to be synchronous</li> <li>if database is configured for sync, usually one of followers is sync, others are async - ‚Äú<em>semi-synchronous</em>‚Äù</li> </ul> </li> <li>Implementation of Replication Logs <ul> <li>Statement-based replication <ul> <li>not generally used (MySQL before 5.1), because problems: <ul> <li>nondeterministic functions e.g. NOW() or RAND()</li> <li>autoincrementing columns</li> <li>side effects (triggers, UDFs, etc)</li> </ul> </li> </ul> </li> <li>Write-ahead-log shipping <ul> <li>WAG: in log structured storage engine, main palce for store. in Btree, WAL before B tree modified</li> <li>used in PostgreSQL and Oracle</li> <li>disadvantage: log very low level - specific disk block and bytes -&gt; problem: <strong>zero-downtime upgrade not possible</strong> if leader and follower can‚Äôt run with different version of storage engine</li> </ul> </li> <li><strong>Logical (row-based) log replication</strong> <ul> <li>decoupled from storage engine internals</li> <li>used by MySQL binlog</li> <li>also can be used by external system, CDC</li> </ul> </li> <li>trigger-based - application layer <ul> <li>Oracle GoldenGate or triggers and Stored Procs</li> </ul> </li> </ul> </li> <li>Dealing with replication lag and eventual consistency <ul> <li>Reading Your Own Writes <ul> <li>option 1: When reading something that the user may have modified, read it from the leader; otherwise, read it from a follower.</li> <li>option 2: track time of last update, and query leader when within some time window</li> <li>option 3: client can remember timestamp and require serving replica up to date</li> </ul> </li> <li>Monotonic Reads: second read lags behind first read <ul> <li>option 1: read from same replica</li> <li>option 2: use sequencer?</li> </ul> </li> <li>consistent prefix read: causual events observed out of order <ul> <li>option 1: causal udpates in the same partition</li> </ul> </li> <li>using transactions - for a database to provide stronger guarantees so that the application can be simpler.</li> </ul> </li> </ul> <h2 id="multi-leader-replication"> <a href="#multi-leader-replication" aria-labelledby="multi-leader-replication" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Multi-leader replication </h2> <ul> <li>use case: <ul> <li>multi-datacenter</li> <li>Clients with offline operation <ul> <li>offline device each has a local database that acts as leader</li> </ul> </li> <li>Collaborative editing</li> </ul> </li> <li>conflict detection likely async - if sync, might as well use single leader</li> <li>conflict avoidance <ul> <li>different ‚Äúhome‚Äù cluster for diff users</li> </ul> </li> <li>achieving convergent conflict resolution <ul> <li>each write unique ID, pick the highest ID</li> <li>assign priority between writers</li> <li>merge the values e.g. concat.</li> <li>record the conflict</li> </ul> </li> <li>custom conflict resolution logic <ul> <li>on write</li> <li>on read</li> </ul> </li> <li>auto conflict resolution research: <ul> <li>Conflict-free replicated datatypes (CRDTs) - family of data structures for sets, maps, ordered lists, counters, etc <ul> <li><a href="https://speakerdeck.com/lenary/crdts-an-update-or-just-a-put">CRDTs slide deck</a></li> </ul> </li> <li>Mergeable persistent data structures - like Git, 3 way merge function <ul> <li><a href="http://gazagnaire.org/pub/FGM15.pdf">Mergeable Persistent Data Structures paper</a></li> </ul> </li> <li>Operational transformation for collab. editing e.g. Google Docs. <ul> <li><a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.53.933&amp;rep=rep1&amp;type=pdf">papaer</a></li> </ul> </li> </ul> </li> <li>Multi-Leader Replication Topologies <ul> <li>all-to-all, circular, or star (generalize to trees)</li> <li>circular or star topology may be broken with one failed node</li> <li>all-to-all has problem of inconsistent ordering</li> </ul> </li> </ul> <h2 id="leaderless-replication---quorum-based"> <a href="#leaderless-replication---quorum-based" aria-labelledby="leaderless-replication---quorum-based" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Leaderless Replication - quorum based </h2> <ul> <li>‚ÄúDynamo-style‚Äù - Riak, Cassandra, and Voldemort, inspired by Amazon Dynamo</li> <li>catch-up options: <ol> <li>Read repair - reader can detect stale response and update</li> <li>anti-entropy - background process</li> </ol> </li> <li>quorum condition: w + r &gt; n - b.c. set of nodes for w and r must overlap</li> <li>issues with quorum: <ul> <li>write partial failure needs to be rolled back</li> <li>eventual consistent without the type of replication lag gaurantees - hard to quantify</li> <li>difficult to mointor staleness</li> </ul> </li> <li>sloppy quorum: writes and reads still require w and r successful responses, but those may include nodes that are not among the designated n ‚Äúhome‚Äù nodes for a value. <ul> <li>once network inerruption is fixed, writes go back to ‚Äúhome‚Äù nodes - <em>hinted handoff</em>. so reads might not see the update.</li> </ul> </li> <li>Multi-datacenter: <ul> <li>Cassandra and Voldemort extends quorum to multi-datacenter. high latency writes to other datacenters often async.</li> <li>Riak - all local. cross-dc happen async in the background</li> </ul> </li> <li>concurrent writes: <ul> <li>the application developer neesd to understand the internals on this</li> <li>Last write wins based on a timestamp <ul> <li>only option in Cassandra</li> <li>optionl on Riak</li> <li>only safe way: each key is immutable</li> </ul> </li> <li>The ‚Äúhappens-before‚Äù relationship: <ol> <li>B depends on A - ‚Äúhappens-before‚Äù</li> <li>A and B are independent - concurrent</li> </ol> </li> <li>Option 1: Capturing the happens-before relationship (client send version number it depends on) <ul> <li>server maintain version for each key</li> <li>when client writes, must include the version of a prev read and merge with it</li> <li>server can clean up versions &lt;= version number received in the write - since it knows it has been merged. then incre curr version # and return it in response</li> </ul> </li> <li>Option 2: Merging concurrently written values <ul> <li>for collections, just union the writes</li> <li>deletes require a tombstones with a version number</li> </ul> </li> <li>version vectors: multiple replicas, each need a version number <ul> <li>collection of version numbers for all replicats</li> <li><a href="https://arxiv.org/pdf/1011.5808v1.pdf">Dotted Version Vectors: Logical Clocks for Optimistic Replication paper</a></li> </ul> </li> </ul> </li> </ul> <h2 id="summary"> <a href="#summary" aria-labelledby="summary" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Summary </h2> <ul> <li>Single-leader replication is popular because it is fairly easy to understand and there is no conflict resolution</li> <li>Multi-leader and quorum based can be more robust in the presence of faulty nodes, network interruptions, and latency spikes‚Äîat the cost of being harder to reason about and providing only very weak consistency guarantees.</li> </ul> <h2 id="reseach-chain-replication"> <a href="#reseach-chain-replication" aria-labelledby="reseach-chain-replication" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Reseach: Chain replication </h2> <ul> <li><a href="https://static.usenix.org/events/osdi04/tech/full_papers/renesse/renesse.pdf">Chain Replication for Supporting High Throughput and Availability</a> paper</li> <li><a href="https://www.usenix.org/legacy/event/usenix09/tech/full_papers/terrace/terrace.pdf">Object Storage on CRAQ High-throughput chain replication for read-mostly workloads</a> paper</li> <li><a href="http://sigops.org/s/conferences/sosp/2011/current/2011-Cascais/printable/11-calder.pdf">Windows Azure Storage: A Highly Available Cloud Storage Service with Strong Consistency</a> paper</li> </ul> <hr> <footer> <p class="text-small text-grey-dk-000 mb-0"></p> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
